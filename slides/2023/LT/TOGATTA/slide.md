---
marp: true
theme: perutheme0
title: tinyWMをちゃんと読む
math: mathjax
author: Teruki TADA
---

# 自己紹介

ぺるきです

---

# X11(X Window System)とは
GUIを実現するためのウィンドウシステム

サーバー・クライアント方式で動作
Xサーバー

*実際のところ、"X11"そのものはソフトウェアではない*
*Xプロトコルを話し、ウインドウシステムを構築するソフトウェア群という認識*

*X11は複雑な設計が問題視され、次世代にあたるWaylandに置き換わりつつある*
*参考: https://wayland.freedesktop.org/architecture.html*

---

# WM (ウインドウマネージャ) とは

デスクトップ上で、ウインドウを管理するミドルウェア

**主な責務**
 - ウインドウの位置関係・前後関係
 - ウインドウの装飾
    - ウインドウのタイトルバーなど

X11では特殊な**クライアント**の一種として扱われており、開発がしやすい

*自作できると面白そうでしょ*

---

# WM (ウインドウマネージャ) とは

基本的にはOS(Windows, MacOS)や
デスクトップ環境(GNOME, KDEなど)に紐付いている

一方で、Linuxでは `i3wm`や`awesome`、`icewm`、`sway`など
独立したWMも使われている

---

# tinyWMとは

https://github.com/mackstann/tinywm

このWMを**50行のCコード**でミニマムに実装したもの
*実用には耐え難いが、ちゃんと動く！*

---

# tinyWMとは

実装されている機能は以下の2(3)つ:
 - ウインドウの移動 
   - 縦横移動
   - 最前面への移動
 - ウインドウの拡大縮小

---

# LTの動機

tinyWMのコードリーディングは
WM開発に入門するアプローチの一つ

自分自身もWM開発には興味があるが
こういったのをしっかり精読したかというとそうでもない

**X11のウインドウマネージャがどう動いてるのか眺めてみる**

---

# ソースコードを見てみよう
https://github.com/mackstann/tinywm

---

# 基本的な流れ

1. **Xサーバーへの接続**
2. **受け取る入力イベントの登録** (グラブ)
3. **メインループ**
     - ユーザーの入力の受け取る
     - 入力の内容をディスプレイに反映

*「登録」という語彙は適切ではないかもしれないが*
*「グラブ」という謎多き操作を説明する日本語の文献が全く見当たらないので、とりあえず適用*

---

# tinyWMの概観

```c
#include <X11/Xlib.h>

int main(void)
{
    ((変数の定義))

    [ ] Xサーバーへの接続
    [ ] 入力の登録(グラブ)

    for(;;)
    {
        [ ] ユーザーの入力の受け取る
        [ ] 入力の内容ごとにディスプレイに反映
    }
}
```

---

# Xサーバーへの接続 - XOpenDisplay

```c
Display * dpy;
```

```c
if(!(dpy = XOpenDisplay(0x0))) return 1;
```


この関数で初めてXサーバーとの通信が確立される
`dpy`には、Xサーバーの情報が挿入される *NULLだったら異常終了*

`dpy`を他のいろんな関数に引き回しすことで、Xサーバーとのやり取りを行う
*Xサーバーとのあらゆるやり取りは**Display型のメソッドとして提供される**と考えるとわかりやすいかも*

---

---


# 参考資料

Linux システムソフトウェア - グラフィックスシステムの概要
https://zenn.dev/hidenori3/articles/c2be2bd50fc8dd